(()=>{"use strict";const e={airlineDetailsMap:{"American Airlines":{display:"American",color:"#C5423E",code:"AA"},American:{display:"American",color:"#C5423E",code:"AA"},Delta:{display:"Delta",color:"#EE722E",code:"DL"},Southwest:{display:"Southwest",color:"#F6C04D",code:"WN"},United:{display:"United",color:"#235EA6",code:"UA"},"Air Canada":{display:"Air Canada",color:"#E53222",code:"AC"},"Alaska Airlines":{display:"Alaska",color:"#51172C",code:"AS"},jetBlue:{display:"jetBlue",color:"#5F90C8",code:"B6"},"JetBlue Airways":{display:"jetBlue",color:"#5F90C8",code:"B6"},"Spirit Airlines":{display:"Spirit",color:"#BBB140",code:"NK"},WestJet:{display:"WestJet",color:"#4BA89C",code:"WS"},Aeromexico:{display:"Aeromexico",color:"#000000",code:"AM"},"Frontier Airlines":{display:"Frontier",color:"#378055",code:"F9"},Interjet:{display:"Interjet",color:"#A8A8A8",code:"4O"},"Hawaiian Airlines":{display:"Hawaiian",color:"#4D388A",code:"HA"},"Sun Country Airlines":{display:"Sun Country",color:"#D79A71",code:"SY"},"Porter Airlines":{display:"Porter",color:"#0F2B53",code:"PD"},"China Southern Airlines":{display:"China Southern",color:"#93ACCA",code:"CZ"},Lufthansa:{display:"Lufthansa",color:"#EFB95D",code:"LH"},SWISS:{display:"Swiss",color:"#D42D21",code:"LX"},"China Eastern Airlines":{display:"China Eastern",color:"#A9545F",code:"MU"},"British Airways":{display:"British",color:"#EA8E8C",code:"BA"},Iberia:{display:"Iberia",color:"#D05653",code:"IB"},"Air China":{display:"Air China",color:"#DF524B",code:"CA"},"Emirates Airlines":{display:"Emirates",color:"#CF534F",code:"EK"},"KLM-Royal Dutch Airlines":{display:"KLM",color:"#44A0DC",code:"KL"},"Air France":{display:"Air France",color:"#DB3832",code:"AF"},"Turkish Airlines":{display:"Turkish",color:"#DB3832",code:"TK"},"Cathay Pacific":{display:"Cathay",color:"#2A645A",code:"CX"},"Cathay Dragon":{display:"Cathay",color:"#2A645A",code:"CX"},"EVA Airways":{display:"EVA",color:"#6F9F64",code:"BR"},"China Airlines":{display:"China Airlines",color:"#DAABB1",code:"CI"},"ANA Airlines":{display:"ANA",color:"#254897",code:"NH"},"Japan Airlines":{display:"Japan Airlines",color:"#E56E69",code:"JL"},"Air India":{display:"Air India",color:"#D47346",code:"AI"},"Qantas Airways":{display:"Qantas",color:"#E34538",code:"QF"},"Singapore Airlines":{display:"Sinagpore",color:"#EFA952",code:"SQ"},"ANA (All Nippon Airways)":{display:"ANA",color:"#0f4a8d"}},getAirlineName:function(e){if(!e||"string"!=typeof e)return;let t=e.trim();const n=this.airlineDetailsMap[t];return n&&(t=n.display),t},getAirlineDetails:function(e){let t=e.trim();return this.airlineDetailsMap[t]||{display:t,color:"#DFCCFB"}}},t=function(e){return e.toLowerCase().replace(" ","").trim()};let n;Sentry.init({dsn:"https://d7f3363dd3774a64ad700b4523bcb789@o407795.ingest.sentry.io/5277451"});let r=!1;const o="[class*='FlightsTicket_container'] [role='button']";let i=0;function l(){r=!1,chrome.runtime.sendMessage({event:"FOCUS_WEBPAGE"})}async function c(){if(r)return;const e=document.querySelector("[class^='FlightsDayView_results__']");if(!e)return p(),void await a();if(r)return;const t=Array.from(e.querySelectorAll("button")).find((e=>"Show more results"===e.textContent));t&&(t.click(),await a()),r||window.scroll(0,window.pageYOffset+500)}function a(){return new Promise((e=>{setTimeout(e,3e3)}))}function s(){return window.innerHeight+window.pageYOffset>=document.body.offsetHeight-2}function d(e=""){let t=Array.from(document.querySelectorAll(o+e));for(let e=0;e<t.length;e++){const n=t[e],r=Array.from(n.querySelectorAll("[class^='LegDetails_container']"));C(n,r),n.dataset.visited="true"}t.length}chrome.runtime.onMessage.addListener((async function(e){switch(e.event){case"BEGIN_PARSING":if(n=e.formData,document.body.textContent.includes("Page not found"))return void chrome.runtime.sendMessage({event:"NO_FLIGHTS_FOUND",provider:"skyscanner"});!function(){let e;new MutationObserver((function(t,l){e=setTimeout((()=>{clearTimeout(e),async function(){if(!document.querySelector(o))return void function(){const e=Array.from(document.getElementsByTagName("button")),t=Array.from(document.querySelectorAll('[role="button"]'));[n.fromDate,n.toDate].forEach((e=>{let n=new Date(`${e}T00:00:00`).toDateString().split(" "),r=n[0]+n[2]+n[1];t.find((e=>e.textContent.includes(r))).click()})),e.find((e=>"Continue"===e.textContent)).click(),chrome.runtime.sendMessage({event:"SEND_BEGIN_EVENT",provider:"skyscanner"})}();if(r)return;let e,t=0;async function l(n){t&&!(n-t>=1e3)||(await c(),t=n),e=window.requestAnimationFrame(l)}window.addEventListener("scroll",(function t(){if(r)return window.cancelAnimationFrame(e),void window.removeEventListener("scroll",t);let n=Array.from(document.querySelectorAll(o+':not([data-visited="true"])'));if(n.length){i+=n.length;const e=function(e=[]){let t=e.map((e=>{if(e.dataset.visited=!0,e.textContent.includes("Sponsored"))return null;let t;try{t=e.querySelector(m).textContent.trim()}catch(e){return null}const n=/\d stop/.test(e.textContent),r=Array.from(e.querySelectorAll("[class^='LegDetails_container']")),o=C(e,r);if(v[o]&&v[o]===t)return null;if(v[o]=t,n)return S.push(o),null;const[i,l]=E(r);return i?{departureFlight:i,returnFlight:l,fare:t.replace("$",""),currency:"$"}:null}));return t=t.filter((e=>e)),t}(n);e.length&&chrome.runtime.sendMessage({event:"FLIGHT_RESULTS_RECEIVED",flights:e,provider:"skyscanner"})}if(s()){if(window.cancelAnimationFrame(e),window.removeEventListener("scroll",t),!i&&!S.length)return void chrome.runtime.sendMessage({event:"NO_FLIGHTS_FOUND",provider:"skyscanner"});if(r)return;S.length&&(window.addEventListener("scroll",(function e(){0===window.pageYOffset&&(h(),window.removeEventListener("scroll",e))})),window.scroll(0,0))}})),e=window.requestAnimationFrame(l)}()}),3e3),l.disconnect()})).observe(document.body,{childList:!0,subtree:!0})}();break;case"HIGHLIGHT_FLIGHT":const{selectedDepartureId:t,selectedReturnId:a}=e;r=!0,p(),function(){let e=document.getElementById("close");e&&e.click();e=document.querySelector("[title='Close']"),e&&e.click()}(),window.cancelAnimationFrame(0),window.scroll(0,0);let u=10;setTimeout((()=>{const e=setInterval((async()=>{try{p(),d(),function(e,t){const n=document.querySelector(`${o}[data-selected='true']`);n&&(n.dataset.selected="false",n.style.border="");let r=e;t&&(r+=`-${t}`);const i=document.querySelector(`[data-id="${r}"]`);i.style.border="10px solid tomato",i.dataset.selected="true";const l=window.pageYOffset+i.getBoundingClientRect().top-window.innerHeight/2;window.scroll(0,l)}(t,a),clearInterval(e),function(){if(document.querySelector("#back-to-search"))return;const e=document.createElement("button");e.id="back-to-search",e.innerText="Return to FlightPenguin",e.title="Click to return to FlightPenguin and keep browsing.",e.addEventListener("click",l),document.body.append(e)}()}catch(t){if(u<1)return Sentry.captureException(t,{tags:{component:"highlightSkyscannerItin"},extra:n}),void clearInterval(e);await c(),u--}}),500)}),500)}}));const u={fromTime:"[class^='LegInfo_routePartialDepart'] *:first-child",toTime:"[class^='LegInfo_routePartialArrive'] *:first-child",duration:"[class^='LegInfo_stopsContainer'] *:first-child",layovers:"[class^='LegInfo_stopsLabelContainer'] *:first-child",marketingAirline:"[class^='LogoImage_container']",operatingAirline:"[class*='Operators_operator']",from:"[class*='LegInfo_routePartialDepart'] *:nth-child(2)",to:"[class*='LegInfo_routePartialArrive'] *:nth-child(2)"},y={from:"[class*='Routes_routes'] *:first-child",to:"[class*='Routes_routes'] *:nth-child(2)"},A="[class^='TotalPrice_totalPriceContainer']",m="[class^='Price_mainPriceContainer']",f="[class*='CardPrice_totalPrice']";function p(){const e=document.querySelector("[class*='DetailsPanelHeader_navigationBar'] button[label='back']");e&&e.click()}const g="[class*='FlightsBookingPanel_content']";async function h(){if(!S.length||r)return void p();window.scroll(0,0);const e=S.shift();window.addEventListener("scroll",(async function t(){if(r)return void window.removeEventListener("scroll",t);const n=await w(e);n?(!function(e){e.click();let t=setInterval((async()=>{const e=document.querySelector(g);if(!e)return;const n=function(e){const t=Array.from(e.querySelectorAll("[class^='Itinerary_leg']")),[n,r]=E(t);let o,i=e.querySelector(A);i||(i=e.querySelector(f));try{o=i.textContent.trim().split("$")[1]}catch(e){return}return{departureFlight:n,returnFlight:r,fare:o,currency:"$"}}(e);n&&(chrome.runtime.sendMessage({event:"FLIGHT_RESULTS_RECEIVED",flights:[n],provider:"skyscanner"}),clearInterval(t),p(),await a(),d(),h())}),2e3)}(n),window.removeEventListener("scroll",t)):s()&&(h(),window.removeEventListener("scroll",t))})),w(e)}async function w(e){return await c(),d(':not([data-visited="true"])'),document.querySelector(`[data-id='${e}']`)}function C(n,r){let o=[];for(let n of r){const[r,i]=n.querySelectorAll("[class*='LegInfo_routePartialTime']"),l=n.querySelector(u.marketingAirline),c=n.getElementsByTagName("img")[0];let a="";a=c?c.alt:l.textContent,a=e.getAirlineName(a),o.push(t(r.textContent),t(i.textContent),a.trim())}const i=o.join("-");return n.dataset.id=i,i}const S=[],v={};function E(e){const t=[];for(const n of e){const e=L(n);t.push(e)}return t}function L(e){const n={};return Object.entries(u).forEach((([r,o])=>{const i=e.querySelector(o);if("operatingAirline"===r)n.operatingAirline=i?i.textContent.replace("Operated by",""):null;else if("marketingAirline"===r){const e=i.querySelector("img");n.marketingAirline=e?e.alt:i.textContent.trim()}else if("layovers"===r){let r=[];i.textContent.toLowerCase().includes("non")||(i.click(),r=function(e){const n=e.querySelector("[class^='LegSegmentSummary_container']"),r=Array.from(n.querySelectorAll("[class^='AirlineLogoTitle_container']")),o=Array.from(n.querySelectorAll("[class^='LegSegmentDetails_container']")),i=[];for(let e=0;e<o.length;e++){let[n,l,c]=o[e].querySelector("[class^='Times_segmentTimes']").children;n=t(n.textContent),c=t(c.textContent);const a={};for(let[t,n]of Object.entries(y)){const r=o[e].querySelector(n);a[t]=r.textContent.split(/\s/)[0]}const s=r[e].querySelector("[class^='LogoImage_container']"),d=r[e].querySelector("[class*='OperatedBy']");i.push({fromTime:n,duration:l.textContent,toTime:c,operatingAirline:d.textContent.toLowerCase().includes("operated")?d.textContent:s.textContent,...a})}return i}(e)),n.layovers=r}else["fromTime","toTime"].includes(r)?n[r]=t(i.textContent):n[r]=i.textContent.trim()})),n}})();