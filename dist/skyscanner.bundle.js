(()=>{"use strict";const e=function(e){return e.toLowerCase().replace(" ","").trim()},t={airlineDetailsMap:{"American Airlines":{display:"American",color:"#C5423E",code:"AA"},American:{display:"American",color:"#C5423E",code:"AA"},Delta:{display:"Delta",color:"#EE722E",code:"DL"},Southwest:{display:"Southwest",color:"#F6C04D",code:"WN"},United:{display:"United",color:"#235EA6",code:"UA"},"Air Canada":{display:"Air Canada",color:"#E53222",code:"AC"},"Alaska Airlines":{display:"Alaska",color:"#51172C",code:"AS"},jetBlue:{display:"jetBlue",color:"#5F90C8",code:"B6"},"JetBlue Airways":{display:"jetBlue",color:"#5F90C8",code:"B6"},"Spirit Airlines":{display:"Spirit",color:"#BBB140",code:"NK"},WestJet:{display:"WestJet",color:"#4BA89C",code:"WS"},Aeromexico:{display:"Aeromexico",color:"#000000",code:"AM"},"Frontier Airlines":{display:"Frontier",color:"#378055",code:"F9"},Interjet:{display:"Interjet",color:"#A8A8A8",code:"4O"},"Hawaiian Airlines":{display:"Hawaiian",color:"#4D388A",code:"HA"},"Sun Country Airlines":{display:"Sun Country",color:"#D79A71",code:"SY"},"Porter Airlines":{display:"Porter",color:"#0F2B53",code:"PD"},"China Southern Airlines":{display:"China Southern",color:"#93ACCA",code:"CZ"},Lufthansa:{display:"Lufthansa",color:"#EFB95D",code:"LH"},SWISS:{display:"Swiss",color:"#D42D21",code:"LX"},"China Eastern Airlines":{display:"China Eastern",color:"#A9545F",code:"MU"},"British Airways":{display:"British",color:"#EA8E8C",code:"BA"},Iberia:{display:"Iberia",color:"#D05653",code:"IB"},"Air China":{display:"Air China",color:"#DF524B",code:"CA"},"Emirates Airlines":{display:"Emirates",color:"#CF534F",code:"EK"},"KLM-Royal Dutch Airlines":{display:"KLM",color:"#44A0DC",code:"KL"},"Air France":{display:"Air France",color:"#DB3832",code:"AF"},"Turkish Airlines":{display:"Turkish",color:"#DB3832",code:"TK"},"Cathay Pacific":{display:"Cathay",color:"#2A645A",code:"CX"},"Cathay Dragon":{display:"Cathay",color:"#2A645A",code:"CX"},"EVA Airways":{display:"EVA",color:"#6F9F64",code:"BR"},"China Airlines":{display:"China Airlines",color:"#DAABB1",code:"CI"},"ANA Airlines":{display:"ANA",color:"#254897",code:"NH"},"Japan Airlines":{display:"Japan Airlines",color:"#E56E69",code:"JL"},"Air India":{display:"Air India",color:"#D47346",code:"AI"},"Qantas Airways":{display:"Qantas",color:"#E34538",code:"QF"},"Singapore Airlines":{display:"Sinagpore",color:"#EFA952",code:"SQ"},"ANA (All Nippon Airways)":{display:"ANA",color:"#0f4a8d"}},getAirlineName:function(e){if(!e||"string"!=typeof e)return;let t=e.trim();const n=this.airlineDetailsMap[t];return n&&(t=n.display),t},getAirlineDetails:function(e){let t=e.trim();return this.airlineDetailsMap[t]||{display:t,color:"#DFCCFB"}}};let n;Sentry.init({dsn:"https://d7f3363dd3774a64ad700b4523bcb789@o407795.ingest.sentry.io/5277451"});let o=!1;const r="[class*='FlightsTicket_container'] [role='button']";let i=0;function l(){o=!1,chrome.runtime.sendMessage({event:"FOCUS_WEBPAGE"})}async function c(){if(o)return;const e=document.querySelector("[class^='FlightsDayView_results__']");if(!e)return g(),void await s();if(o)return;const t=[...e.querySelectorAll("button")].find((e=>"Show more results"===e.textContent));t&&(t.click(),await s()),o||window.scroll(0,window.pageYOffset+500)}function s(){return new Promise((e=>{setTimeout(e,3e3)}))}function a(){return window.innerHeight+window.pageYOffset>=document.body.offsetHeight-2}function d(e=""){let t=[...document.querySelectorAll(r+e)];for(const e of t){const t=[...e.querySelectorAll("[class^='LegDetails_container']")];S(e,t),e.dataset.visited="true"}}chrome.runtime.onMessage.addListener((async function(e){switch(e.event){case"BEGIN_PARSING":if(n=e.formData,document.body.textContent.includes("Page not found"))return void chrome.runtime.sendMessage({event:"NO_FLIGHTS_FOUND",provider:"skyscanner"});!function(){let e;new MutationObserver((function(t,l){e=setTimeout((()=>{clearTimeout(e),async function(){if(!document.querySelector(r))return void function(){const e=[...document.querySelectorAll("button")],t=[...document.querySelectorAll('[role="button"]')];for(const e of[n.fromDate,n.toDate]){let n=new Date(`${e}T00:00:00`).toDateString().split(" "),o=n[0]+n[2]+n[1];t.find((e=>e.textContent.includes(o))).click()}e.find((e=>"Continue"===e.textContent)).click(),chrome.runtime.sendMessage({event:"SEND_BEGIN_EVENT",provider:"skyscanner"})}();if(o)return;let e,t=0;async function l(n){t&&!(n-t>=350)||(await c(),t=n),e=window.requestAnimationFrame(l)}window.addEventListener("scroll",(function t(){if(o)return window.cancelAnimationFrame(e),void window.removeEventListener("scroll",t);let n=[...document.querySelectorAll(r+':not([data-visited="true"])')];if(n.length>0){i+=n.length;const e=function(e=[]){let t=e.map((e=>{if(e.dataset.visited=!0,e.textContent.includes("Sponsored"))return null;let t;try{t=e.querySelector(f).textContent.trim()}catch{return null}const n=/\d stop/.test(e.textContent),o=[...e.querySelectorAll("[class^='LegDetails_container']")],r=S(e,o);if(E[r]&&E[r]===t)return null;if(E[r]=t,n)return v.push(r),null;const[i,l]=L(o);return i?{departureFlight:i,returnFlight:l,fare:t.replace("$",""),currency:"$"}:null}));return t=t.filter((e=>e)),t}(n);e.length>0&&chrome.runtime.sendMessage({event:"FLIGHT_RESULTS_RECEIVED",flights:e,provider:"skyscanner"})}if(a()){if(window.cancelAnimationFrame(e),window.removeEventListener("scroll",t),!i&&0===v.length)return void chrome.runtime.sendMessage({event:"NO_FLIGHTS_FOUND",provider:"skyscanner"});if(o)return;v.length>0&&(window.addEventListener("scroll",(function e(){0===window.pageYOffset&&(w(),window.removeEventListener("scroll",e))})),window.scroll(0,0))}})),e=window.requestAnimationFrame(l)}()}),3e3),l.disconnect()})).observe(document.body,{childList:!0,subtree:!0})}();break;case"HIGHLIGHT_FLIGHT":const{selectedDepartureId:t,selectedReturnId:s}=e;o=!0,g(),function(){let e=document.querySelector("#close");e&&e.click();e=document.querySelector("[title='Close']"),e&&e.click()}(),window.cancelAnimationFrame(0),window.scroll(0,0);let u=10;setTimeout((()=>{const e=setInterval((async()=>{try{g(),d(),function(e,t){const n=document.querySelector(`${r}[data-selected='true']`);n&&(n.dataset.selected="false",n.style.border="");let o=e;t&&(o+=`-${t}`);const i=document.querySelector(`[data-id="${o}"]`);i.style.border="10px solid #f2554b",i.style.borderRadius="6px",i.style.paddingTop="25px",i.style.paddingBottom="25px",i.dataset.selected="true";const l=window.pageYOffset+i.getBoundingClientRect().top-window.innerHeight/2;window.scroll(0,l)}(t,s),clearInterval(e),function(){if(document.querySelector("#back-to-search"))return;const e=document.createElement("button");e.id="back-to-search",e.textContent="Return to FlightPenguin",e.title="Click to return to FlightPenguin and keep browsing.",e.addEventListener("click",l),document.body.append(e)}()}catch(t){if(u<1)return Sentry.captureException(t,{tags:{component:"highlightSkyscannerItin"},extra:n}),void clearInterval(e);await c(),u--}}),500)}),500)}}));const u={fromTime:"[class^='LegInfo_routePartialDepart'] *:first-child",toTime:"[class^='LegInfo_routePartialArrive'] *:first-child",duration:"[class^='LegInfo_stopsContainer'] *:first-child",layovers:"[class^='LegInfo_stopsLabelContainer'] *:first-child",marketingAirline:"[class^='LogoImage_container']",operatingAirline:"[class*='Operators_operator']",from:"[class*='LegInfo_routePartialDepart'] *:nth-child(2)",to:"[class*='LegInfo_routePartialArrive'] *:nth-child(2)"},y={from:"[class*='Routes_routes'] *:first-child",to:"[class*='Routes_routes'] *:nth-child(2)"},A="[class^='TotalPrice_totalPriceContainer']",f="[class^='Price_mainPriceContainer']",m="[class*='CardPrice_totalPrice']";function p(t){const n=t.querySelector("[class^='LegSegmentSummary_container']"),o=[...n.querySelectorAll("[class^='AirlineLogoTitle_container']")],r=[...n.querySelectorAll("[class^='LegSegmentDetails_container']")],i=[];for(const[t,n]of r.entries()){let[r,l,c]=n.querySelector("[class^='Times_segmentTimes']").children;r=e(r.textContent),c=e(c.textContent);const s={};for(let[e,t]of Object.entries(y)){const o=n.querySelector(t);s[e]=o.textContent.split(/\s/)[0]}const a=o[t].querySelector("[class^='LogoImage_container']"),d=o[t].querySelector("[class*='OperatedBy']");i.push({fromTime:r,duration:l.textContent,toTime:c,operatingAirline:d.textContent.toLowerCase().includes("operated")?d.textContent:a.textContent,...s})}return i}function g(){const e=document.querySelector("[class*='DetailsPanelHeader_navigationBar'] button[label='back']");e&&e.click()}const h="[class*='FlightsBookingPanel_content']";async function w(){if(0===v.length||o)return void g();window.scroll(0,0);const e=v.shift();window.addEventListener("scroll",(async function t(){if(o)return void window.removeEventListener("scroll",t);const n=await C(e);n?(!function(e){e.click();let t=setInterval((async()=>{const e=document.querySelector(h);if(!e)return;const n=function(e){const t=[...e.querySelectorAll("[class^='Itinerary_leg']")],[n,o]=L(t);let r,i=e.querySelector(A);i||(i=e.querySelector(m));try{r=i.textContent.trim().split("$")[1]}catch{return}return{departureFlight:n,returnFlight:o,fare:r,currency:"$"}}(e);n&&(chrome.runtime.sendMessage({event:"FLIGHT_RESULTS_RECEIVED",flights:[n],provider:"skyscanner"}),clearInterval(t),g(),await s(),d(),w())}),2e3)}(n),window.removeEventListener("scroll",t)):a()&&(w(),window.removeEventListener("scroll",t))})),C(e)}async function C(e){return await c(),d(':not([data-visited="true"])'),document.querySelector(`[data-id='${e}']`)}function S(n,o){let r=[];for(let n of o){const[o,i]=n.querySelectorAll("[class*='LegInfo_routePartialTime']"),l=n.querySelector(u.marketingAirline),c=n.querySelectorAll("img")[0];let s="";s=c?c.alt:l.textContent,s=t.getAirlineName(s),r.push(e(o.textContent),e(i.textContent),s.trim())}const i=r.join("-");return n.dataset.id=i,i}const v=[],E={};function L(e){const t=[];for(const n of e){const e=F(n);t.push(e)}return t}function F(t){const n={};for(const[o,r]of Object.entries(u)){const i=t.querySelector(r);switch(o){case"operatingAirline":n.operatingAirline=i?i.textContent.replace("Operated by",""):null;break;case"marketingAirline":{const e=i.querySelector("img");n.marketingAirline=e?e.alt:i.textContent.trim();break}case"layovers":{let e=[];i.textContent.toLowerCase().includes("non")||(i.click(),e=p(t)),n.layovers=e;break}default:["fromTime","toTime"].includes(o)?n[o]=e(i.textContent):n[o]=i.textContent.trim()}}return n}})();