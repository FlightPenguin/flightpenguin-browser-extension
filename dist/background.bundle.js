(()=>{"use strict";const e="https://subscribe.flightpenguin.com",t={airlineDetailsMap:{"American Airlines":{display:"American",color:"#C5423E",code:"AA"},American:{display:"American",color:"#C5423E",code:"AA"},Delta:{display:"Delta",color:"#EE722E",code:"DL"},Southwest:{display:"Southwest",color:"#F6C04D",code:"WN"},United:{display:"United",color:"#235EA6",code:"UA"},"Air Canada":{display:"Air Canada",color:"#E53222",code:"AC"},"Alaska Airlines":{display:"Alaska",color:"#51172C",code:"AS"},jetBlue:{display:"jetBlue",color:"#5F90C8",code:"B6"},"JetBlue Airways":{display:"jetBlue",color:"#5F90C8",code:"B6"},"Spirit Airlines":{display:"Spirit",color:"#BBB140",code:"NK"},WestJet:{display:"WestJet",color:"#4BA89C",code:"WS"},Aeromexico:{display:"Aeromexico",color:"#000000",code:"AM"},"Frontier Airlines":{display:"Frontier",color:"#378055",code:"F9"},Interjet:{display:"Interjet",color:"#A8A8A8",code:"4O"},"Hawaiian Airlines":{display:"Hawaiian",color:"#4D388A",code:"HA"},"Sun Country Airlines":{display:"Sun Country",color:"#D79A71",code:"SY"},"Porter Airlines":{display:"Porter",color:"#0F2B53",code:"PD"},"China Southern Airlines":{display:"China Southern",color:"#93ACCA",code:"CZ"},Lufthansa:{display:"Lufthansa",color:"#EFB95D",code:"LH"},SWISS:{display:"Swiss",color:"#D42D21",code:"LX"},"China Eastern Airlines":{display:"China Eastern",color:"#A9545F",code:"MU"},"British Airways":{display:"British",color:"#EA8E8C",code:"BA"},Iberia:{display:"Iberia",color:"#D05653",code:"IB"},"Air China":{display:"Air China",color:"#DF524B",code:"CA"},"Emirates Airlines":{display:"Emirates",color:"#CF534F",code:"EK"},"KLM-Royal Dutch Airlines":{display:"KLM",color:"#44A0DC",code:"KL"},"Air France":{display:"Air France",color:"#DB3832",code:"AF"},"Turkish Airlines":{display:"Turkish",color:"#DB3832",code:"TK"},"Cathay Pacific":{display:"Cathay",color:"#2A645A",code:"CX"},"Cathay Dragon":{display:"Cathay",color:"#2A645A",code:"CX"},"EVA Airways":{display:"EVA",color:"#6F9F64",code:"BR"},"China Airlines":{display:"China Airlines",color:"#DAABB1",code:"CI"},"ANA Airlines":{display:"ANA",color:"#254897",code:"NH"},"Japan Airlines":{display:"Japan Airlines",color:"#E56E69",code:"JL"},"Air India":{display:"Air India",color:"#D47346",code:"AI"},"Qantas Airways":{display:"Qantas",color:"#E34538",code:"QF"},"Singapore Airlines":{display:"Sinagpore",color:"#EFA952",code:"SQ"},"ANA (All Nippon Airways)":{display:"ANA",color:"#0f4a8d"}},getAirlineName:function(e){if(!e||"string"!=typeof e)return;let t=e.trim();const i=this.airlineDetailsMap[t];return i&&(t=i.display),t},getAirlineDetails:function(e){let t=e.trim();return this.airlineDetailsMap[t]||{display:t,color:"#DFCCFB"}}},i=["Aer Lingus Regional","Aeromexico Connect","SkyWest","Alaska Horizon","Horizon Air","Alitalia CityLiner","Air Canada Express","Air New Zealand Link","American Eagle","Delta Connection","Fiji Link","HOP!","Iberia Regional","KLM Cityhopper","Lufthansa Regional","MoÃ§ambique Expresso","Ohana by Hawaiian","PAL Express","QantasLink","South African Express","TAP Express","Tunisair Express","United Express","Virgin Australia Regional Airlines","WestJet Encore","WestJet Link"];const r=function(e){const t=e.toLowerCase(),r=i.find((e=>t.includes(e.toLowerCase())));return Boolean(r)};function o(e,t){let i=e.toLowerCase(),[r,o]=i.split(":");r=Number(r);let n=Number(o.replace(/(pm)|(am)|(\+\d)/g,"").trim());if(t){const t=e.match(/(\+\d)/);t&&(r+=24*t[0].split("+")[1])}return i.includes("pm")&&r%12!=0?r+=12:i.includes("am")&&r%12==0&&(r-=12),{hours:r,minutes:n}}function n(e){let t,i;e.includes("h")?[t,i]=e.split("h"):(t=0,i=e);let r=i.trim().split("m")[0]||0;return Number(r)+60*Number(t)}function s(e,t,i){let{hours:r,minutes:s}=o(e),{hours:a,minutes:l}=o(t);const c=t.match(/(\+\d)/),d=e.match(/(\+\d)/);let p=0,u=0;if(d){const[e,t]=d[0].split("+");p+=Number(t),u=p}if(c){const[e,t]=c[0].split("+");u+=Number(t)}const h=60*(r+24*p)+s,m=60*(a+24*u)+l;return n(i)-(m-h)}function a(e){const{hours:t,minutes:i}=o(e,!0),r=e.toLowerCase().match(/(pm)|(am)/)[0],n=e.match(/(\+\d)/);return{hours:t,displayHours:Number(e.split(":")[0]),minutes:i,timeOfDay:r,excessDays:n?n[0]:n}}function l(e,i,o,s,l,d){this.fromTime=e,this.toTime=i,this.fromTimeDetails=a(e),this.toTimeDetails=a(i);let p=o?o.replace("Operated by","").replace("Partially operated by",""):o;p=t.getAirlineName(p);const u=t.getAirlineName(s);if(p){const e=o.includes("Partially operated by");r(p)||e?(this.operatingAirline=u,this.marketingAirlineText=e?o:`Operated by ${p}`):(this.operatingAirline=p,this.marketingAirlineText=`Marketed by ${u}`)}else this.operatingAirline=u;this.operatingAirline=c(this.operatingAirline),this.id=`${this.fromTime}-${this.toTime}-${u}`,this.duration=l,this.durationMinutes=n(l),this.layovers=d||[],this.itinIds=[],this.timezoneOffset=this.calculateTimezoneOffset()}function c(e){let i=[e];e.includes("Partially operated by")?i=e.split("Partially operated by "):e.includes("Operated by")&&(i=e.split("Operated by"));const r=i[i.length-1].trim().split(" + ");let o;return o=1===r.length?r[0]:r.map((e=>t.getAirlineName(e.replace("  "," ")))).join(", "),t.getAirlineDetails(o.replace("  "," "))}function d(e,t){for(let[i,r]of Object.entries(e)){let e=1;if(r.layovers.length)for(let t=1;t<r.layovers.length;t++)if(r.layovers[t-1].to!==r.layovers[t].from){e=2;break}const i=t[r.itinIds.sort(((e,i)=>t[e].fareNumber-t[i].fareNumber))[0]].fareNumber;r.pain=(Math.log2(r.durationMinutes)+Math.log2(i)+r.layovers.length)*e}return Object.values(e).sort(((e,t)=>e.pain-t.pain))}function p(e,t,i,r,o,n,s,a){this.depFlight=a?e:new l(e.fromTime,e.toTime,e.operatingAirline,e.marketingAirline,e.duration,e.layovers),t?(this.retFlight=new l(t.fromTime,t.toTime,t.operatingAirline,t.marketingAirline,t.duration,t.layovers),this.id=`${this.depFlight.id}-${this.retFlight.id}`):this.id=this.depFlight.id,this.provider=o,this.windowId=n,this.tabId=s,this.fareNumber=Number(`${i}`.match(/\d+/g).join("")),this.currency=r}function u(e,t,i,r,o,n,s=!1){const a={};return e.forEach((e=>{const l=new p(e.departureFlight,e.returnFlight,e.fare,e.currency,r,o,n,s);t[l.depFlight.id]?l.depFlight=t[l.depFlight.id]:t[l.depFlight.id]=l.depFlight,l.retFlight&&(a[l.retFlight.id]?l.retFlight=a[l.retFlight.id]:a[l.retFlight.id]=l.retFlight,l.retFlight.itinIds.push(l.id)),l.depFlight.itinIds.push(l.id),i[l.id]=l})),{itins:i,departures:t,returns:a}}l.prototype.calculateTimezoneOffset=function(){let e=0;if(this.layovers.length){const t=this.layovers.map((({fromTime:t,toTime:i,duration:r,operatingAirline:o},n)=>(e+=s(t,i,r),{...this.layovers[n],operatingAirline:c(o),timezoneOffset:e}))),i=[];for(let e=0;e<t.length-1;e++){const r=t[e],o=t[e+1];let{toTime:n,to:s}=r,{fromTime:a,from:l}=o;i.push(r),i.push({fromTime:n,toTime:a,from:s,to:l,isLayoverStop:!0,operatingAirline:{display:`Layover at ${s}.`,color:"transparent"}})}i.push(t[t.length-1]),this.layovers=i}else e=s(this.fromTime,this.toTime,this.duration);return e},Sentry.init({dsn:"https://d7f3363dd3774a64ad700b4523bcb789@o407795.ingest.sentry.io/5277451"}),chrome.runtime.setUninstallURL("https://forms.gle/s1BfyyBQb5qtXr7H6",(function(){Sentry.captureMessage("uninstall")})),chrome.runtime.onInstalled.addListener((function(){}));let h=!1;chrome.browserAction.onClicked.addListener((function(){h||(h=!0,chrome.identity.getAuthToken({interactive:!0},(async t=>{await(i=t,fetch("https://www.googleapis.com/oauth2/v1/userinfo?alt=json",{method:"GET",headers:new Headers({Authorization:`Bearer ${i}`})}).then((e=>{if(200===e.status)return e.json();throw new Error(e.status)})));var i;try{const{status:i}=await function(e){return fetch("https://www.googleapis.com/oauth2/v1/userinfo?alt=json",{method:"GET",credentials:"include",mode:"cors",headers:new Headers({"Content-Type":"application/json",Authorization:`Bearer ${e}`})}).then((e=>{if(200===e.status)return e.json();throw new Error(e.status)}))}(t);i?k({}):chrome.tabs.create({url:e})}catch{chrome.tabs.create({url:e})}finally{h=!1}})))}));let m,f,A,y,g={},E={},b={},w=[],T={},C={},D=!1,L=!1,F=!0,I=[],S=0,N=new Set,v=new Set,$={};function _(e){m?chrome.tabs.get(m,(t=>{t?chrome.tabs.sendMessage(t.id,e):k(e)})):k(e)}function R(e){b.searchByPoints?chrome.tabs.create({url:"https://flightpenguin.com/flight-penguin-points"}):chrome.windows.update(E[e.provider],{focused:!0},(t=>{chrome.tabs.sendMessage(e.tabId,{event:"HIGHLIGHT_FLIGHT",selectedDepartureId:e.depFlight.id,selectedReturnId:e.retFlight?e.retFlight.id:"",provider:e.provider})}))}function x(){for(const e of Object.values(E))chrome.windows.remove(e)}function k(e){chrome.tabs.create({url:chrome.extension.getURL("./index.html")},(t=>{window.setTimeout((()=>{chrome.tabs.sendMessage(t.id,e)}),1e3),f=t.windowId,m=t.id,A=t.index}))}chrome.runtime.onMessage.addListener((function(e,t,i){switch(e.event){case"FORM_DATA_RECEIVED":b={...e.formData,from:e.formData.from.toUpperCase(),to:e.formData.to.toUpperCase()},async function(e,t){const{searchByPoints:i}=e;let r=[];r=i?["expedia"]:["southwest","skyscanner","expedia"];const o=r.map((i=>function(e,t,i,r){const{height:o,width:n,left:s,top:a}=i;return new Promise((i=>{chrome.windows.create({url:e,focused:!1,height:o,width:n,left:s,top:a},(async e=>{g[t]=e.tabs[0].id,E[t]=e.id,chrome.tabs.onUpdated.addListener((function e(o,n){"complete"===n.status&&o===g[t]&&(chrome.tabs.onUpdated.removeListener(e),chrome.tabs.sendMessage(g[t],{event:"BEGIN_PARSING",formData:r}),S||(S=performance.now()),i())}))}))}))}(B[i](e),i,t,e)));await Promise.all(o),chrome.windows.update(f,{focused:!0})}(b,e.windowConfig),x(),g={},E={},T={},C={},D=!1,I=[],N=new Set,v=new Set,L=!1,w=[],$={},F=!0,y=null,m&&chrome.tabs.sendMessage(m,{event:"RESET_SEARCH",formData:b});break;case"NO_FLIGHTS_FOUND":v.add(e.provider),clearTimeout($[e.provider]),v.size>=Object.keys(g).length&&(_({event:"NO_FLIGHTS_FOUND_CLIENT"}),x()),Sentry.captureException(new Error(`No flights found ${e.provider}`,{extra:b}));break;case"FAILED_SCRAPER":!function(e){v.add(e),v.size>=Object.keys(g).length&&(_({event:"FAILED_SCRAPER_CLIENT"}),x());Sentry.captureException(new Error(`Scraper failed for ${e}`),{extra:b})}(e.provider);break;case"FLIGHT_RESULTS_RECEIVED":if(D)break;const{flights:t,provider:i}=e;if(clearTimeout($[i]),0===t.length)break;N.has(i)||(Sentry.captureMessage(`${i} flight results took ${performance.now()-S}`),N.add(i));const{departures:r,itins:o}=u(t,T,C,i,E[i],g[i]);C={...o},T={...r};_({event:"FLIGHT_RESULTS_FOR_CLIENT",flights:{departureList:d(T,C),itins:C},tabId:g[i],formData:b});break;case"RETURN_FLIGHTS_RECEIVED":const{flights:n,provider:s}=e;if(0===n.length)return;clearTimeout($.expedia);const{itins:a,returns:l}=u(n,T,C,s,E[s],g[s],!0);C={...C,...a};let c=Object.values(l);c=d(c,C),w=w.concat(c),chrome.tabs.sendMessage(m,{event:"RETURN_FLIGHTS_FOR_CLIENT",flights:{returnList:w,itins:a}});break;case"DEPARTURE_SELECTED":if(!b.roundtrip)return;D=!0;const p=T[e.departureId],h=p.itinIds.flatMap((e=>C[e])),k=h.map((e=>e.provider));if(k.includes("expedia")){const e=()=>{chrome.tabs.sendMessage(g.expedia,{event:"GET_RETURN_FLIGHTS",departure:p,itin:h[k.indexOf("expedia")]}),$.expedia=setTimeout((()=>{Sentry.captureException(new Error("Scraper failed for expedia"),{extra:b})}),1e4)};F?e():y=e}else(k.includes("skyscanner")||k.includes("southwest"))&&(w=function(e,t){return e.itinIds.map((e=>t[e].retFlight))}(p,C),w=d(w,C),chrome.tabs.sendMessage(m,{event:"RETURN_FLIGHTS_FOR_CLIENT",flights:{returnList:w}}));break;case"HIGHLIGHT_TAB":const{selectedDepartureId:O,selectedReturnId:M}=e;let H=O;M&&(H+=`-${M}`),R(C[H]);break;case"SKYSCANNER_READY":if(L=!0,I.length>0)for(const e of I)R(e);break;case"SEND_BEGIN_EVENT":setTimeout((()=>{chrome.tabs.sendMessage(g[e.provider],{event:"BEGIN_PARSING",formData:b})}),2e3);break;case"EXPEDIA_READY":F=!0,y&&(y(),y=null);break;case"FOCUS_WEBPAGE":_({event:"FOCUS_WEBPAGE_CLIENT"}),chrome.windows.update(f,{focused:!0},(e=>{chrome.tabs.highlight({tabs:[A]})}));break;case"CLEAR_SELECTIONS":w=[],g.expedia&&(F=!1,chrome.tabs.sendMessage(g.expedia,{event:"CLEAR_SELECTION"}))}})),chrome.tabs.onRemoved.addListener((function(e){e===m&&x()}));const B={priceline:function(e){const{from:t,to:i,fromDate:r,toDate:o,numPax:n,cabin:s}=e;return`https://www.priceline.com/m/fly/search/${t}-${i}-${r.replace(/-/g,"")}/${i}-${t}-${o.replace(/-/g,"")}/?cabin-class=${H[s]}&num-adults=${n}`},southwest:function(e){const{from:t,to:i,fromDate:r,toDate:o,numPax:n,roundtrip:s}=e,a=t.toUpperCase(),l=i.toUpperCase();let c=`https://www.southwest.com/air/booking/select.html?adultPassengersCount=${n}&departureDate=${r}&departureTimeOfDay=ALL_DAY&destinationAirportCode=${l}&fareType=USD&int=HOMEQBOMAIR&originationAirportCode=${a}&passengerType=ADULT&reset=true&seniorPassengersCount=0`;return c+=s?`&returnDate=${o}&returnTimeOfDay=ALL_DAY&tripType=roundtrip`:"&returnDate=&returnTimeOfDay=ALL_DAY&tripType=oneway",c},skyscanner:function(e){const{from:t,to:i,fromDate:r,toDate:o,numPax:n,cabin:s,roundtrip:a}=e,l=r.replace(/-/g,"").slice(2);let c=`https://www.skyscanner.com/transport/flights/${t}/${i}/${l}/`;if(a){const e=o.replace(/-/g,"").slice(2);c+=`${e}/`}return`${c}?adults=${n}&children=0&adultsv2=${n}&childrenv2=&infants=0&cabinclass=${M[s]}`},expedia:function(e){const{from:t,to:i,fromDate:r,toDate:o,numPax:n,cabin:s,roundtrip:a}=e,l=d(r);let c=`https://www.expedia.com/Flights-Search?mode=search&trip=${a?"roundtrip":"oneway"}&leg1=from:${t},to:${i},departure:${l}TANYT&leg2=from:${i},to:${t},`;function d(e){const[t,i,r]=e.split("-");return[i,r,t].join("/")}if(a){const e=d(o);c+=`departure:${e}TANYT`}else c+=`departure:${l}TANYT`;return c+=`&passengers=adults:${n},children:0,seniors:0,infantinlap:N&options=carrier:*,`,c+=`cabinclass:${O[s]},`,c+="maxhops:1,nopenalty:N&pageId=0",c}},O={econ:"economy",prem_econ:"premium_economy",business:"business",first:"first"};const M={econ:"economy",prem_econ:"premiumeconomy",business:"business",first:"first"};const H={econ:"ECO",prem_econ:"PEC",business:"BUS",first:"FST"}})();