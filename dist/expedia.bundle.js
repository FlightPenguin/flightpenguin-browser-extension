(()=>{"use strict";const e={airlineDetailsMap:{"American Airlines":{display:"American",color:"#C5423E",code:"AA"},American:{display:"American",color:"#C5423E",code:"AA"},Delta:{display:"Delta",color:"#EE722E",code:"DL"},Southwest:{display:"Southwest",color:"#F6C04D",code:"WN"},United:{display:"United",color:"#235EA6",code:"UA"},"Air Canada":{display:"Air Canada",color:"#E53222",code:"AC"},"Alaska Airlines":{display:"Alaska",color:"#51172C",code:"AS"},jetBlue:{display:"jetBlue",color:"#5F90C8",code:"B6"},"JetBlue Airways":{display:"jetBlue",color:"#5F90C8",code:"B6"},"Spirit Airlines":{display:"Spirit",color:"#BBB140",code:"NK"},WestJet:{display:"WestJet",color:"#4BA89C",code:"WS"},Aeromexico:{display:"Aeromexico",color:"#000000",code:"AM"},"Frontier Airlines":{display:"Frontier",color:"#378055",code:"F9"},Interjet:{display:"Interjet",color:"#A8A8A8",code:"4O"},"Hawaiian Airlines":{display:"Hawaiian",color:"#4D388A",code:"HA"},"Sun Country Airlines":{display:"Sun Country",color:"#D79A71",code:"SY"},"Porter Airlines":{display:"Porter",color:"#0F2B53",code:"PD"},"China Southern Airlines":{display:"China Southern",color:"#93ACCA",code:"CZ"},Lufthansa:{display:"Lufthansa",color:"#EFB95D",code:"LH"},SWISS:{display:"Swiss",color:"#D42D21",code:"LX"},"China Eastern Airlines":{display:"China Eastern",color:"#A9545F",code:"MU"},"British Airways":{display:"British",color:"#EA8E8C",code:"BA"},Iberia:{display:"Iberia",color:"#D05653",code:"IB"},"Air China":{display:"Air China",color:"#DF524B",code:"CA"},"Emirates Airlines":{display:"Emirates",color:"#CF534F",code:"EK"},"KLM-Royal Dutch Airlines":{display:"KLM",color:"#44A0DC",code:"KL"},"Air France":{display:"Air France",color:"#DB3832",code:"AF"},"Turkish Airlines":{display:"Turkish",color:"#DB3832",code:"TK"},"Cathay Pacific":{display:"Cathay",color:"#2A645A",code:"CX"},"Cathay Dragon":{display:"Cathay",color:"#2A645A",code:"CX"},"EVA Airways":{display:"EVA",color:"#6F9F64",code:"BR"},"China Airlines":{display:"China Airlines",color:"#DAABB1",code:"CI"},"ANA Airlines":{display:"ANA",color:"#254897",code:"NH"},"Japan Airlines":{display:"Japan Airlines",color:"#E56E69",code:"JL"},"Air India":{display:"Air India",color:"#D47346",code:"AI"},"Qantas Airways":{display:"Qantas",color:"#E34538",code:"QF"},"Singapore Airlines":{display:"Sinagpore",color:"#EFA952",code:"SQ"},"ANA (All Nippon Airways)":{display:"ANA",color:"#0f4a8d"}},getAirlineName:function(e){if(!e||"string"!=typeof e)return;let t=e.trim();const i=this.airlineDetailsMap[t];return i&&(t=i.display),t},getAirlineDetails:function(e){let t=e.trim();return this.airlineDetailsMap[t]||{display:t,color:"#DFCCFB"}}},t=function(e){return e.toLowerCase().replace(" ","").trim()};Sentry.init({dsn:"https://d7f3363dd3774a64ad700b4523bcb789@o407795.ingest.sentry.io/5277451"});const i={};let o,r;async function n(e,t=null,o=10){try{if(o<1)return document.querySelector("[data-test-id='loading-animation']")&&await n(e,t),Sentry.captureException(i.lastError,{extra:{callback:e,sendEvent:t}}),void chrome.runtime.sendMessage({event:"NO_FLIGHTS_FOUND",provider:"expedia"});let r=await e();t&&t(r);const a=document.querySelector("[name='showMoreButton']");a&&(a.click(),await d(),r=await e(),r&&!r.length&&(await d(),r=await e()),t&&t(r))}catch(r){i.lastError=r,await d(),await n(e,t,--o)}}function a(e){chrome.runtime.sendMessage({event:"FLIGHT_RESULTS_RECEIVED",flights:e,provider:"expedia"})}function l(e){chrome.runtime.sendMessage({event:"RETURN_FLIGHTS_RECEIVED",flights:e,provider:"expedia"})}function s(e,t,i){const o=document.querySelector(`${i}[data-selected='true']`);o&&(o.dataset.selected="false",o.style.border="");let r=e;t&&(r+=`-${t}`);const n=(a=Array.from(document.querySelectorAll(i)),l=r,a.find((e=>e.dataset.id===l)));var a,l;n.style.border="10px solid tomato",n.dataset.selected="true";const s=window.pageYOffset+n.getBoundingClientRect().top-window.innerHeight/2;window.scroll(0,s)}function c(){return new Promise((e=>{setTimeout(e,500)}))}function d(){return new Promise((e=>{setTimeout(e,2e3)}))}function u(){const e=document.querySelector(A.flightContainer);if(!e)return;const t=e.dataset.id?A.flightContainerSecondPass:A.flightContainer;return Array.from(document.querySelectorAll(t))}async function m(){const i=u();if(!i)return Promise.reject();if(0===i.length)throw new Error("Empty results");const n=[];for(let a=0;a<i.length;a++){if(r)return;const l=i[a];try{const i={};let r=l.querySelector(A.marketingAirline),a=l.querySelector(A.operatingAirline);r.childNodes.length>1&&([r,a]=r.childNodes),i.marketingAirline=e.getAirlineName(r.textContent),a&&([_,i.operatingAirline]=a.textContent.split("operated by ")),l.querySelector(A.clickToOpenModal).click(),await c();let s=document.querySelector(A.modalViewContainerDesktop);s||(s=document.querySelector(A.modalViewContainerMobile));const d=s.querySelector(A.modalViewSummaryContainer),[u,m]=Array.from(d.querySelectorAll("span:not(.is-visually-hidden)")).map((e=>e.textContent));[i.fromTime,i.toTime]=u.split(" - "),i.fromTime=t(i.fromTime),i.toTime=t(i.toTime);let p=d.textContent.match(/(\+\d)/);p&&(i.toTime+=p[0]),[i.duration]=m.split("(");const y=!m.includes("Nonstop");s.querySelector(A.openModalViewLegsContainer).click();const h=s.querySelector(A.modalViewLegsContainer).children,C=[];if(y)for(let e=0;e<h.length;e++){const[i,o,r]=h[e].children;let n=i.textContent,a=n.split(" - ")[0].toLowerCase().replace("departure",""),l=n.slice(n.indexOf("(")+1,n.indexOf(")")),s=o.children[0].textContent.replace("flight",""),c=o.children[1].textContent.match(/[A-z]*/g).join(" ").trim(),d=r.textContent,u=d.split(" - ")[0].toLowerCase().replace("arrival","");(e>0&&C[C.length-1].toTime.includes("pm")&&u.includes("am")||a.toLowerCase().includes("pm")&&u.toLowerCase().includes("am"))&&(u+="+1");let m=d.slice(d.indexOf("(")+1,d.indexOf(")"));C.push({fromTime:t(a),toTime:t(u),from:l,to:m,operatingAirline:c,duration:s})}i.layovers=C;let g=null,f=null,S=null;o?(l.dataset.id=[o.id,i.fromTime,i.toTime,i.marketingAirline].join("-"),g=o,f=i,S=l.querySelector(A.listFare).textContent):(l.dataset.id=[i.fromTime,i.toTime,i.marketingAirline].join("-"),g=i,S=s.querySelector(A.modalFare).textContent),n.push({departureFlight:g,returnFlight:f,fare:S}),s.querySelector(A.closeModalViewButton).click()}catch(e){console.log(e)}}return n}function p(i=""){const o=u();for(let r of o){let[o,n]=r.querySelector("[data-test-id='departure-time']").textContent.split(" - ");const a=r.querySelector("[data-test-id='arrives-next-day']");a&&(n+=a.textContent.trim());let l=r.querySelector(A.marketingAirline).textContent;l=e.getAirlineName(l);const s=[];i&&s.push(i),s.push(t(o),t(n),l.trim());const c=s.join("-");if(r.dataset.id=c,i===c)return}}chrome.runtime.onMessage.addListener((async function(e){switch(console.log("Received message ",e),e.event){case"BEGIN_PARSING":n(m,a);break;case"GET_RETURN_FLIGHTS":o=e.departure,await async function(e){let t=document.querySelector(`[data-id='${e}']`);t||(await n((()=>p(e))),t=document.querySelector(`[data-id='${e}']`)),t.querySelector("button").click(),document.querySelector('[data-test-id="select-button"]').click(),await c();try{await n(m,l)}catch(e){console.log(e),chrome.runtime.sendMessage({event:"FAILED_SCRAPER",source:"expedia",description:`${e.name} ${e.message}`})}}(e.departure.id);break;case"HIGHLIGHT_FLIGHT":r=!0;const{selectedDepartureId:t,selectedReturnId:i}=e;try{s(t,i,A.flightContainer)}catch(e){s(t,i,y.flightContainer)}!function(){if(document.querySelector("#back-to-search"))return;const e=document.createElement("button");e.id="back-to-search",e.innerText="Return to FlightPenguin",e.title="Click to return to FlightPenguin and keep browsing.",e.addEventListener("click",(()=>{chrome.runtime.sendMessage({event:"FOCUS_WEBPAGE"})})),document.body.append(e)}();break;case"CLEAR_SELECTION":r=!1,o=null,history.back(),await d(),await n(p),chrome.runtime.sendMessage({event:"EXPEDIA_READY"})}}));const A={flightContainer:"[data-test-id='offer-listing']",flightContainerSecondPass:"[data-test-id='offer-listing']:not([data-id])",marketingAirline:"[data-test-id='flight-operated']",operatingAirline:"[data-test-id='operated-by']",modalFare:"footer section span",listFare:".uitk-price-subtext",clickToOpenModal:"[data-test-id='select-link']",modalViewContainerDesktop:"[data-test-id='listing-details-and-fares']:not(:empty)",modalViewContainerMobile:".uitk-dialog-content",openModalViewLegsContainer:"[data-test-id='show-details-link'] button",modalViewLegsContainer:"[data-test-id='flight-details']",modalViewSummaryContainer:"[data-test-id='flight-summary']",closeModalViewButton:"button[data-icon='tool-close']"},y={flightContainer:".flight-module.segment.offer-listing",loadingSelector:"#skeleton-listing"}})();